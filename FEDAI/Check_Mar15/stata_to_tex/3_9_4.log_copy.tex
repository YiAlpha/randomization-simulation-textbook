. 
. 
. cap program drop ate_block

. 
. program define ate_block, rclass
  1. args Y D probs
  2. tempvar ipw
  3. gen `ipw' = .
  4. // calculate inverse probability weight under block assignment
. replace `ipw' = `D'/`probs' + (1-`D')/(1-`probs')
  5. qui reg `Y' `D' [iw=`ipw']
  6. return scalar ate=_b[`D']
  7. end 

. 
. 
. ritest D r(ate), strata(block) reps(10000) nodots: ///
> ate_block change D probs
(34 missing values generated)
(34 real changes made)

      command:  ate_block change D probs
        _pm_1:  r(ate)
  res. var(s):  D
   Resampling:  Permuting D
Clust. var(s):  __000000
     Clusters:  34
Strata var(s):  block
       Strata:  17

\HLI{13}{\TOPT}\HLI{64}
T            {\VBAR}     T(obs)       c       n   p=c/n   SE(p) [95\% Conf. Interval]
\HLI{13}{\PLUS}\HLI{64}
       _pm_1 {\VBAR}  -110.1765    3170   10000  0.3170  0.0047  .3078845   .3262222
\HLI{13}{\BOTT}\HLI{64}
Note: Confidence interval is with respect to p=c/n.
Note: c = \#{\lbr}|T| >= |T(obs)|{\rbr}

. 
. 
. // ate
. di el(r(b),1,1)
-110.17647

. 
. // p.value.twosided
. di el(r(p),1,1)
.317

