. 
. // calculate probs under block assignment
. bysort block: egen probs=mean(D)
{\smallskip}
. 
. 
. 
. cap program drop ate_block
{\smallskip}
. 
. program define ate_block, rclass
  1. args Y D probs
  2. tempvar ipw
  3. gen `ipw' = .
  4. // calculate inverse probability weight under block assignment
. replace `ipw' = `D'/`probs' + (1-`D')/(1-`probs')
  5. qui reg `Y' `D' [iw=`ipw']
  6. return scalar ate=_b[`D']
  7. end 
{\smallskip}
. 
. // ssc install ritest (to install ritest package)
. 
. //
. ritest D r(ate), strata(block) reps(10000) nodots: ///
> ate_block Y D probs
(66 missing values generated)
(66 real changes made)
{\smallskip}
      command:  ate_block Y D probs
        _pm_1:  r(ate)
  res. var(s):  D
   Resampling:  Permuting D
Clust. var(s):  __000000
     Clusters:  66
Strata var(s):  block
       Strata:  2
{\smallskip}
\HLI{13}{\TOPT}\HLI{64}
T            {\VBAR}     T(obs)       c       n   p=c/n   SE(p) [95\% Conf. Interval]
\HLI{13}{\PLUS}\HLI{64}
       _pm_1 {\VBAR}   -13.2168      65   10000  0.0065  0.0008    .00502   .0082774
\HLI{13}{\BOTT}\HLI{64}
Note: Confidence interval is with respect to p=c/n.
Note: c = \#{\lbr}|T| >= |T(obs)|{\rbr}
{\smallskip}
. 
. 
. // ate
. di el(r(b),1,1)
-13.216796
{\smallskip}
. 
. // p.value.twosided
. di el(r(p),1,1)
.0065
{\smallskip}
. 
